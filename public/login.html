<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="loginTitle">Login - POS System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/favicon.ico">
</head>
<body class="bg-light" id="loginBody">
    <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <div class="text-center mb-3">
                            <img id="loginLogo" src="" alt="Logo" style="display:none; object-fit:contain;" />
                        </div>
                        <h2 class="text-center mb-4" id="loginTitleText">POS Login</h2>
                        <form id="loginForm">
                            <div class="mb-3"><label for="username" class="form-label">Username</label><input type="text" class="form-control" id="username" required></div>
                            <div class="mb-3"><label for="password" class="form-label">Password</label><input type="password" class="form-control" id="password" required></div>
                            <button type="submit" class="btn btn-primary w-100" id="loginButton">Login</button>
                        </form>
                        <div id="alertContainer" class="mt-3"></div>
                        <div id="licenseSectionLogin" class="mt-3 d-none">
                            <hr>
                            <h6>LICENSE KEY</h6>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="licenseKeyInputLogin" placeholder="Masukkan LICENSE KEY">
                                <button class="btn btn-outline-primary" type="button" id="licenseSaveBtnLogin">Simpan</button>
                            </div>
                            <div id="licenseStatusLogin" class="small text-muted"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="/js/login.js"></script>
    <script src="/js/back-to-top.js"></script>
    <script>
      (function () {
        async function refreshLicenseLogin() {
          try {
            var section = document.getElementById('licenseSectionLogin');
            var statusEl = document.getElementById('licenseStatusLogin');
            var loginBtn = document.getElementById('loginButton');
            if (!section || !statusEl) return;
            var resp = await fetch('/api/license/status', { headers: { 'Accept': 'application/json' } });
            if (!resp.ok) return;
            var data = await resp.json();
            var off = data && data.offline;
            var lock = data && data.lock;

            // Jika ada lock (license habis / dicurangi), paksa input LICENSE KEY baru dan nonaktifkan tombol login
            if (lock && lock.locked) {
              section.classList.remove('d-none');
              statusEl.textContent = 'LICENSE KEY sudah habis. Masukkan LICENSE KEY baru.';
              if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Login (terkunci)';
              }
              return;
            }

            // Jika license offline masih valid, sembunyikan section license dan aktifkan login
            if (off && off.valid) {
              section.classList.add('d-none');
              if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
              }
            } else {
              section.classList.remove('d-none');

              // Jika sudah kadaluarsa atau terdeteksi manipulasi waktu, langsung paksa pengisian LICENSE KEY
              if (off && off.reason === 'EXPIRED') {
                statusEl.textContent = 'Masa berlaku LICENSE KEY sudah habis. Masukkan LICENSE KEY baru.';
                if (loginBtn) {
                  loginBtn.disabled = true;
                  loginBtn.textContent = 'Login (terkunci)';
                }
              } else if (off && off.reason === 'CLOCK_TAMPER') {
                statusEl.textContent = 'LICENSE KEY diblokir karena terdeteksi manipulasi waktu sistem. Masukkan LICENSE KEY baru.';
                if (loginBtn) {
                  loginBtn.disabled = true;
                  loginBtn.textContent = 'Login (terkunci)';
                }
              } else {
                // Kasus lain (belum ada license, salah format, dsb): tetap izinkan login setelah diisi
                if (off && off.reason) {
                  statusEl.textContent = 'License belum aktif (' + off.reason + ')';
                } else {
                  statusEl.textContent = 'License belum aktif';
                }
                if (loginBtn) {
                  loginBtn.disabled = false;
                  loginBtn.textContent = 'Login';
                }
              }
            }
          } catch (e) {}
        }

        async function submitLicenseLogin() {
          try {
            var input = document.getElementById('licenseKeyInputLogin');
            var statusEl = document.getElementById('licenseStatusLogin');
            if (!input || !statusEl) return;
            var key = String(input.value || '').trim();
            if (!key) {
              statusEl.textContent = 'LICENSE KEY wajib diisi';
              return;
            }
            statusEl.textContent = 'Memeriksa LICENSE KEY...';
            var resp = await fetch('/api/license/offline', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify({ licenseKey: key })
            });
            var data = null;
            try { data = await resp.json(); } catch (e) {}
            if (resp.ok && data && data.success) {
              statusEl.textContent = 'LICENSE KEY valid. Terima kasih.';
              input.value = '';
              await refreshLicenseLogin();
            } else {
              var msg = (data && data.message) ? data.message : 'LICENSE KEY tidak valid';
              statusEl.textContent = msg;
            }
          } catch (e) {}
        }

        function initLicenseLogin() {
          refreshLicenseLogin();
          var btn = document.getElementById('licenseSaveBtnLogin');
          if (btn) {
            btn.addEventListener('click', function (ev) {
              ev.preventDefault();
              submitLicenseLogin();
            });
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initLicenseLogin);
        } else {
          initLicenseLogin();
        }
      })();
    </script>
    
    <!-- Back to Top Button -->
    <button id="backToTopBtn" class="btn btn-primary back-to-top" title="Back to Top">
        <i class="bi bi-arrow-up"></i>
    </button>
</body>
</html>